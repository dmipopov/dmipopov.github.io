<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#ee81c2}</style><title>Hide Kubernetes secrets with helm-secrets, sops and vals</title><meta name=description content="Hi, I am a 4th year cybersec student at HSE and DevOps engineer. This blog is for fun, do not take it too seriously."><meta name=keywords content="blog,dmipopov,devops,golang,Дмитрий,Попов,Kubernetes,Helm"><meta property="og:url" content="http://dmipopov.github.io/posts/hide_kubernetes_secrets_with_helm_secrets_sops_and_vals/"><meta property="og:type" content="website"><meta property="og:title" content="Hide Kubernetes secrets with helm-secrets, sops and vals"><meta property="og:description" content="Hi, I am a 4th year cybersec student at HSE and DevOps engineer. This blog is for fun, do not take it too seriously."><meta property="og:image" content="/img/preview_kubernetes_helm_secrets.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Hide Kubernetes secrets with helm-secrets, sops and vals"><meta name=twitter:description content="Hi, I am a 4th year cybersec student at HSE and DevOps engineer. This blog is for fun, do not take it too seriously."><meta property="twitter:domain" content="http://dmipopov.github.io/posts/hide_kubernetes_secrets_with_helm_secrets_sops_and_vals/"><meta property="twitter:url" content="http://dmipopov.github.io/posts/hide_kubernetes_secrets_with_helm_secrets_sops_and_vals/"><meta name=twitter:image content="/img/preview_kubernetes_helm_secrets.png"><link rel=canonical href=http://dmipopov.github.io/posts/hide_kubernetes_secrets_with_helm_secrets_sops_and_vals/><link rel=stylesheet type=text/css href=http://dmipopov.github.io//css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=http://dmipopov.github.io//css/main.css><link disabled id=dark-theme rel=stylesheet href=http://dmipopov.github.io//css/dark.css><script src=http://dmipopov.github.io//js/svg-injector.min.js></script>
<script src=http://dmipopov.github.io//js/feather-icons.min.js></script>
<script src=http://dmipopov.github.io//js/main.js></script><meta name=google-site-verification content="paFPDfNajAuHa6zUeXNw9bLL7S8pder-EknsuBxDoBM"></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=http://dmipopov.github.io/><img src=http://dmipopov.github.io//face.jpeg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=http://dmipopov.github.io/>Dmitry Popov</a></div><div class=nav-links><div class=nav-link><a href=http://dmipopov.github.io/posts/>Posts</a></div><div class=nav-link><a href=http://dmipopov.github.io/tags/>Tags</a></div><div class=nav-link><a href=http://dmipopov.github.io/files/popov_devops.pdf>CV</a></div><div class=nav-link><a href=https://github.com/dmipopov><span data-feather=github></span></a></div><div class=nav-link><a href=https://www.linkedin.com/in/dmipopov/><span data-feather=linkedin></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=http://dmipopov.github.io/posts/>Posts</a></li><li class=nav-item><a href=http://dmipopov.github.io/tags/>Tags</a></li><li class=nav-item><a href=http://dmipopov.github.io/files/popov_devops.pdf>CV</a></li><li class=nav-item><a href=https://github.com/dmipopov><span data-feather=github></span></a></li><li class=nav-item><a href=https://www.linkedin.com/in/dmipopov/><span data-feather=linkedin></span></a></li><li class="nav-item dark-theme-toggle"><a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Hide Kubernetes secrets with helm-secrets, sops and vals</h1><small role=doc-subtitle></small><p class=post-date>March 31, 2022</p><ul class=post-tags><li class=post-tag><a href=http://dmipopov.github.io/tags/kubernetes>Kubernetes</a></li><li class=post-tag><a href=http://dmipopov.github.io/tags/helm>Helm</a></li></ul></div><div class=post-content><p><h2 id=methods-of-secrets-delivery>Methods of secrets delivery</h2><p>Secrets need to be somehow delivered to Kubernetes clusters. There are two different approaches for this: <em>pull</em> and <em>push</em>.</p><h3 id=pull>Pull</h3><p>Secrets are delivered to clusters after deployment. For instance, if we use Helm Charts, we can specify metadata instead of the secret value.</p><p>We do not add secret values to the manifests at all, but specify only metadata. Secrets are created based on this metadata and downloaded from external storage &ndash; for example, <em>Hashicorp Vault</em>.</p><h3 id=push>Push</h3><p>Secrets are delivered to clusters immediately during deployment. We specify secrets in the manifests when creating resources with secrets in the process of deployment.</p><p>The easiest way to store secrets safely in repository &ndash; encrypt them in manifests or in Helm Charts. And we decrypt them only when we apply our manifests. Or after apply, if we use an intermediate k8s resource.</p><p>The example below describes <em>push</em> method with Helm plugin <em>helm-secrets</em>, <em>sops</em> and <em>vals</em>. This combination of tools allow us to safely store secrets in git repository and easily deploy Helm Charts with decrypted secrets without <em>Hashicorp Vault</em> installation and maintenance.</p><h2 id=sops>Sops</h2><p><a href=https://github.com/mozilla/sops>Sops</a> allows us to encrypt YAML/JSON files with AWS KMS, GCP KMS, Azure Key Vault and PGP.</p><p>In this example we will be using PGP key. Let&rsquo;s generate it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gpg --gen-key
</span></span></code></pre></div><p>Fill in your full name and email and you&rsquo;ll see:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>public and secret key created and signed.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pub   ed25519 2022-03-30 <span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>expires: 2024-03-29<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>      770281CBDD9AD22235A1790DC10C6C36DA3C6597
</span></span><span style=display:flex><span>uid                      Dmitry Popov &lt;dmipopov01@gmail.com&gt;
</span></span><span style=display:flex><span>sub   cv25519 2022-03-30 <span style=color:#ff79c6>[</span>E<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>expires: 2024-03-29<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>You can list all your keys with <code>gpg --list-keys</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>/home/dima/.gnupg/pubring.kbx
</span></span><span style=display:flex><span>-----------------------------
</span></span><span style=display:flex><span>pub   ed25519 2022-03-30 <span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>expires: 2024-03-29<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>      770281CBDD9AD22235A1790DC10C6C36DA3C6597
</span></span><span style=display:flex><span>uid           <span style=color:#ff79c6>[</span>ultimate<span style=color:#ff79c6>]</span> Dmitry Popov &lt;dmipopov01@gmail.com&gt;
</span></span><span style=display:flex><span>sub   cv25519 2022-03-30 <span style=color:#ff79c6>[</span>E<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>expires: 2024-03-29<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pub   ed25519 2022-03-30 <span style=color:#ff79c6>[</span>SC<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>expires: 2024-03-29<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>      907DA4CB86ECFCCE67CF01FF1D5C44EF6E555F1A
</span></span><span style=display:flex><span>uid           <span style=color:#ff79c6>[</span>ultimate<span style=color:#ff79c6>]</span> Dmitry Popov &lt;dmipopov01@sberbank.ru&gt;
</span></span><span style=display:flex><span>sub   cv25519 2022-03-30 <span style=color:#ff79c6>[</span>E<span style=color:#ff79c6>]</span> <span style=color:#ff79c6>[</span>expires: 2024-03-29<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>I have 2 keys on my host and we can use different keys for dev- and prod-environment.</p><p>Let&rsquo;s create secrets that we want to encrypt:</p><p><em>secrets.dev.yaml</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>dev</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>redis_password</span>: <span style=color:#f1fa8c>&#34;amazing_redis_password&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>app_api_key</span>: <span style=color:#f1fa8c>&#34;1a2b3c4d&#34;</span>
</span></span></code></pre></div><p><em>secrets.prod.yaml</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>prod</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>redis_password</span>: <span style=color:#f1fa8c>&#34;shhhhh_redis_password&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>app_api_key</span>: <span style=color:#f1fa8c>&#34;12312312312121231312313&#34;</span>
</span></span></code></pre></div><p>Now let&rsquo;s create <em>.sops.yaml</em> to specify file masks and PGP keys for them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>creation_rules</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>path_regex</span>: \.*dev*\.yaml$
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>pgp</span>: 770281CBDD9AD22235A1790DC10C6C36DA3C6597
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>path_regex</span>: \.*prod*\.yaml$
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>pgp</span>: 907DA4CB86ECFCCE67CF01FF1D5C44EF6E555F1A
</span></span></code></pre></div><p>Let&rsquo;s encypt our dev secrets:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sops -e secrets.dev.yaml &gt; enc.secrets.dev.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat enc.secrets.dev.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dev:
</span></span><span style=display:flex><span>    redis_password: ENC<span style=color:#ff79c6>[</span>AES256_GCM,data:CsIjY1m02nXRbEmwbRuRlOjA3XAH0A<span style=color:#ff79c6>==</span>,iv:KIDiAkJHk/iOfaQmQFneIae3bMM21nwHM+3XQueq0/I<span style=color:#ff79c6>=</span>,tag:FGSDIO45xV4F+i6etL03sA<span style=color:#ff79c6>==</span>,type:str<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    app_api_key: ENC<span style=color:#ff79c6>[</span>AES256_GCM,data:JZguc/TXYKM<span style=color:#ff79c6>=</span>,iv:so3U6MQekqaz4HKZ9c/+Q8VAFRUbqr8mXwE+kp5gdt0<span style=color:#ff79c6>=</span>,tag:D69EWGAKkOxg6Brm6zIJqw<span style=color:#ff79c6>==</span>,type:str<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>sops:
</span></span><span style=display:flex><span>    kms: <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>    gcp_kms: <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>    azure_kv: <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>    hc_vault: <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>    age: <span style=color:#ff79c6>[]</span>
</span></span><span style=display:flex><span>    lastmodified: <span style=color:#f1fa8c>&#34;2022-03-30T20:39:21Z&#34;</span>
</span></span><span style=display:flex><span>    mac: ENC<span style=color:#ff79c6>[</span>AES256_GCM,data:Yqmx+PagcpPH7VM5pbq+9Z3c5bhhtMb1vkIgoHn9TLHeJylT7vRrXLYCjVzR9jNFaWtPo8voToF9xbBXfAtHBkW2xgAe3tG/ckOFSf0+SH2I3ReCKbdUOn5TTiIFZJhSZSYruCgjPwvHH6Ghd0qA8tVMKKF8eir50h7G8/mGnSs<span style=color:#ff79c6>=</span>,iv:lltyB5VyzgHkmlgobqh/Fi7NlqjV9wLICrm9qQLY/84<span style=color:#ff79c6>=</span>,tag:Kbyy37K9kN9+8Fpyk7eGzw<span style=color:#ff79c6>==</span>,type:str<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>    pgp:
</span></span><span style=display:flex><span>        - created_at: <span style=color:#f1fa8c>&#34;2022-03-30T20:39:00Z&#34;</span>
</span></span><span style=display:flex><span>          enc: |
</span></span><span style=display:flex><span>            -----BEGIN PGP MESSAGE-----
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            hF4DFRPRFvydS5gSAQdAXkkCfQJ4+GcAl4r8v/6GaIYXbqK34nsWzGbK9bCwsQUw
</span></span><span style=display:flex><span>            z4ibV8tO2OGjRDxgRlEwCaua33pqO98uhz8UYb2q6UQOGjMWNf7yk6e4ZnNXR5n0
</span></span><span style=display:flex><span>            1GgBCQIQGvPhXe71G8As/VY11fxtAynLrQyVC+M6zveyfA7HU9RuBQBJir6frmY8
</span></span><span style=display:flex><span>            6v0k3wjVWR9YfezCr/dl9QreAy/vYgmgbDI3+D0zxIrw/h55WKGVlgRYSrAetg+f
</span></span><span style=display:flex><span>            Rs5tFC/Ugdhxrg<span style=color:#ff79c6>==</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>=</span>BG+c
</span></span><span style=display:flex><span>            -----END PGP MESSAGE-----
</span></span><span style=display:flex><span>          fp: 770281CBDD9AD22235A1790DC10C6C36DA3C6597
</span></span><span style=display:flex><span>    unencrypted_suffix: _unencrypted
</span></span><span style=display:flex><span>    version: 3.7.2
</span></span></code></pre></div><p>As we can see sops saved the structure of <em>secrets.dev.yaml</em> and now our secrets are encrpyted.</p><p>Command <code>sops -d enc.secrets.dev.yaml</code> will decrypt and print our secrets.</p><p>For in-place editing use <code>sops -i</code>. You have to carry keys, but it&rsquo;s easy to import them:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gpg --armor --export-secret-key 770281CBDD9AD22235A1790DC10C6C36DA3C6597 &gt; key-prod.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ gpg --allow-secret-key-import --import key-prod.gpg
</span></span></code></pre></div><h2 id=helm-secrets--sops>Helm-secrets + sops</h2><p><a href=https://github.com/jkroepke/helm-secrets>Helm-secrets</a> &ndash; is Helm plugin that can be used with sops when we want to deploy Helm Chart.</p><p>Installation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm plugin install https://github.com/jkroepke/helm-secrets --version v3.12.0
</span></span></code></pre></div><p>Some helm-secrets features:</p><ul><li>Print out secrets with <code>helm secrets view secrets.dev.yaml</code></li><li>In-place encryption with <code>helm secrets enc secrets.dev.yaml</code></li><li>Editing with <code>helm secrets edit secrets.dev.yaml</code> by <code>$EDITOR</code></li><li>Automatic rendering of secret values while deploying:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm secrets upgrade --install some-app -f values.yaml -f secrets.dev.yaml
</span></span></code></pre></div><p>The biggest disadvantage of helm-secrets &ndash; you can&rsquo;t use several drivers at the same time.</p><h2 id=helm-secrets--sops--vals>Helm-secrets + sops + vals</h2><p><a href=https://github.com/variantdev/vals>Vals</a> &ndash; tool that allows us to refer to different sources of secrets: sops, vault, aws, gcp.</p><p>We&rsquo;ll be using vals as driver for helm-secret.</p><p>Using vals is pretty easy &ndash; just store link to secret value directly in <code>values.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>dev</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>secret1</span>: ref+sops://path/to/file#/foo/bar
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>secret2</span>: ref+vault://mykv/foo#/bar?address=https://vault1.example.com:8200
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>secret3</span>: ref+gcs://BUCKET/KEY/OF/OBJECT[?generation=ID]
</span></span></code></pre></div><p><strong>The killer feature of vals is that we can place secrets from different sources in 1 file.</strong></p><p>We can simply view our secrets from <code>values.yaml</code> by vals:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm secrets -d vals view values.yaml -
</span></span></code></pre></div><p>Render our secrets file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm secrets -d vals -f values.yaml template .
</span></span></code></pre></div><p>And deploy with decrypted secrets:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm secrets -d vals upgrade --install some-app -f values.yaml
</span></span></code></pre></div><p>The combination of <em>helm-secrets</em>, <em>sops</em> and <em>vals</em> simplifies management of secrets. It gives the ability to store them safely in git, the only thing to do is to manage GPG keys. And in the future it will be easier for you to migrate from sops to secrets storage such as <em>Hashicorp Vault</em> or <em>AWS Secrets Manager</em>.</p></p></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><a href=#methods-of-secrets-delivery>Methods of secrets delivery</a><ul><li><a href=#pull>Pull</a></li><li><a href=#push>Push</a></li></ul></li><li><a href=#sops>Sops</a></li><li><a href=#helm-secrets--sops>Helm-secrets + sops</a></li><li><a href=#helm-secrets--sops--vals>Helm-secrets + sops + vals</a></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2022 Dmitry Popov</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>